<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Time Lapse App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#222222">
  <link rel="icon" href="icon-192.png">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
  </script>
  <style>
    body { font-family: sans-serif; background: #222; color: #fff; text-align: center; margin: 0; }
    #video { width: 100vw; max-width: 640px; height: auto; background: #000; position: relative; }
    #canvas { display: none; }
    #controls { margin: 20px; }
    #liveTimestamp {
      position: absolute;
      right: 10px;
      bottom: 10px;
      background: rgba(0,0,0,0.5);
      color: #fff;
      font-size: 1em;
      padding: 4px 10px;
      border-radius: 8px;
      pointer-events: none;
      z-index: 10;
      width: max-content;
    }
    .video-container {
      display: inline-block;
      position: relative;
      width: 100vw;
      max-width: 640px;
    }
    @media (max-width: 700px) {
      #video, .video-container { width: 100vw; max-width: 100vw; }
      #liveTimestamp { font-size: 0.9em; right: 4vw; bottom: 4vw; }
    }
    button, input[type="time"] {
      font-size: 1.1em;
      padding: 10px 18px;
      border-radius: 8px;
      margin: 5px;
    }
  </style>
</head>
<body>
  <h1>üì∏ Time Lapse App</h1>
  <div class="video-container">
    <video id="video" autoplay playsinline></video>
    <div id="liveTimestamp"></div>
  </div>
  <canvas id="canvas"></canvas>
  <div id="controls">
    <button id="startBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢</button>
    <button id="stopBtn" disabled>‡∏´‡∏¢‡∏∏‡∏î</button>
  </div>
  <div style="margin:10px;">
    <label>‡∏´‡∏¢‡∏∏‡∏î‡∏ñ‡πà‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà</label>
    <input type="time" id="pauseStart" value="18:00">
    <label>‡∏ñ‡∏∂‡∏á</label>
    <input type="time" id="pauseEnd" value="06:00">
  </div>
  <!-- ‡πÉ‡∏™‡πà‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏á input ‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡∏ñ‡πà‡∏≤‡∏¢ -->
  <div style="margin:10px;">
    <label>
      <input type="checkbox" id="darkPauseMode">
      ‡∏´‡∏¢‡∏∏‡∏î‡∏ñ‡πà‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏á‡∏°‡∏∑‡∏î (Night Pause Mode)
    </label>
  </div>
  <div id="status" style="margin:20px;font-size:1.2em;color:#0f0;">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡πà‡∏≤‡∏¢</div>
  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const pauseStart = document.getElementById('pauseStart');
    const pauseEnd = document.getElementById('pauseEnd');
    const statusDiv = document.getElementById('status');
    const darkPauseMode = document.getElementById('darkPauseMode');
    const liveTimestamp = document.getElementById('liveTimestamp');
    let stream = null;
    let intervalId = null;
    let frames = [];

    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
    async function startCamera() {
      try {
        // ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ñ‡πâ‡∏≤‡∏°‡∏µ (‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)
        const constraints = {
          video: { facingMode: { ideal: "environment" }, width: { ideal: 1280 }, height: { ideal: 720 } }
        };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
      } catch (e) {
        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ' + e.message);
      }
    }
    startCamera();

    function setStatus(text, color="#0f0") {
      statusDiv.textContent = text;
      statusDiv.style.color = color;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î timestamp ‡∏ó‡∏µ‡πà‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á
    function drawTimestamp(ctx, width, height) {
      ctx.font = width < 500 ? "16px sans-serif" : "24px sans-serif";
      ctx.textBaseline = "bottom";
      ctx.textAlign = "right";
      ctx.fillStyle = "rgba(0,0,0,0.5)";
      ctx.fillRect(width-320, height-40, 320, 40);
      ctx.fillStyle = "#fff";
      ctx.fillText(text, width-10, height-10);
    }

    // ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏ü‡∏£‡∏°
    function captureFrame() {
      if (isPauseTime()) {
        setStatus('‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á)', "#ff0");
        return;
      }
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      drawTimestamp(ctx, canvas.width, canvas.height);

      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏¢‡∏∏‡∏î‡∏ñ‡πà‡∏≤‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏∑‡∏î ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á
      if (darkPauseMode.checked && !isBrightEnough(ctx, canvas.width, canvas.height)) {
        setStatus('‡∏´‡∏¢‡∏∏‡∏î‡∏ñ‡πà‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (‡πÅ‡∏™‡∏á‡∏°‡∏∑‡∏î)', "#ff0");
        return;
      }

      frames.push(canvas.toDataURL('image/jpeg', 0.9));
      setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡πà‡∏≤‡∏¢', "#0f0");
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢ timelapse
    startBtn.onclick = () => {
      frames = [];
      setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡πà‡∏≤‡∏¢', "#0f0");
      intervalId = setInterval(() => {
        if (!isPauseTime()) {
          captureFrame();
        } else {
          setStatus('‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß', "#ff0");
        }
      },20000); // ‡∏ñ‡πà‡∏≤‡∏¢‡∏ó‡∏∏‡∏Å 20‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ)
      startBtn.disabled = true;
      stopBtn.disabled = false;
    };

    // ‡∏´‡∏¢‡∏∏‡∏î‡∏ñ‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
    stopBtn.onclick = async () => {
      clearInterval(intervalId);
      setStatus('‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡πà‡∏≤‡∏¢', "#f00");
      startBtn.disabled = false;
      stopBtn.disabled = true;
      if (frames.length === 0) return;

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏à‡∏≤‡∏Å‡πÄ‡∏ü‡∏£‡∏°
      const videoCanvas = document.createElement('canvas');
      videoCanvas.width = video.videoWidth;
      videoCanvas.height = video.videoHeight;
      const ctx = videoCanvas.getContext('2d');
      const stream = videoCanvas.captureStream(10); // 10 fps
      const recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
      const chunks = [];
      recorder.ondataavailable = e => { if (e.data.size) chunks.push(e.data); };
      recorder.start();

      for (let i = 0; i < frames.length; i++) {
        await new Promise(resolve => {
          const img = new Image();
          img.onload = () => {
            ctx.drawImage(img, 0, 0, videoCanvas.width, videoCanvas.height);
            setTimeout(resolve, 100); // 10 fps
          };
          img.src = frames[i];
        });
      }
      recorder.stop();

      recorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `timelapse-${new Date().toISOString().replace(/[:.]/g,'-')}.webm`;
        a.click();
      };
    };

    function isPauseTime() {
      const now = new Date();
      const nowMinutes = now.getHours() * 60 + now.getMinutes();

      const [startH, startM] = pauseStart.value.split(':').map(Number);
      const [endH, endM] = pauseEnd.value.split(':').map(Number);
      const startMinutes = startH * 60 + startM;
      const endMinutes = endH * 60 + endM;

      if (startMinutes < endMinutes) {
        // ‡∏ä‡πà‡∏ß‡∏á‡∏´‡∏¢‡∏∏‡∏î‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
        return nowMinutes >= startMinutes && nowMinutes < endMinutes;
      } else {
        // ‡∏ä‡πà‡∏ß‡∏á‡∏´‡∏¢‡∏∏‡∏î‡∏Ç‡πâ‡∏≤‡∏°‡∏ß‡∏±‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 18:00 ‡∏ñ‡∏∂‡∏á 06:00)
        return nowMinutes >= startMinutes || nowMinutes < endMinutes;
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á (‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ true ‡∏ñ‡πâ‡∏≤‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏≠)
    function isBrightEnough(ctx, width, height, threshold = 40) {
      const imageData = ctx.getImageData(0, 0, width, height);
      let sum = 0;
      for (let i = 0; i < imageData.data.length; i += 4) {
        const avg = (imageData.data[i] + imageData.data[i+1] + imageData.data[i+2]) / 3;
        sum += avg;
      }
      const brightness = sum / (width * height);
      return brightness > threshold;
    }

    function updateLiveTimestamp() {
      const now = new Date();
      liveTimestamp.textContent = now.toLocaleString('th-TH', { dateStyle: 'short', timeStyle: 'medium' });
    }
    setInterval(updateLiveTimestamp, 1000);
    updateLiveTimestamp();
  </script>
</body>
</html>
